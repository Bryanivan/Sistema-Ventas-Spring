<!doctype html>
<html lang="en">
<!--título de web, metas, dependencias CSS/JS-->
<head th:include="fragments/header :: header (pageName='Generar factura')">
</head>

<body>
    <div class="wrapper">
        <div th:include="fragments/sidenav :: sidenav" class="sidebar" data-color="purple" data-image="../img/sidebar-1.jpg"></div>

        <div class="main-panel">
            <nav th:include="fragments/navbar :: navbar" class="navbar navbar-transparent navbar-absolute"></nav>
            <div class="content">
                <div class="container-fluid">
                    <div class="row">                        
                        <div class="col-md-12">
                            <div class="card ordenCompras">
                                <div class="card-header" data-background-color="purple">
                                    <h4 class="title">Generar factura</h4>
                                </div>
                                <div  id="factura" class="card-content table-responsive">
                                    <form>
                                        <fieldset>
                                            <h5 class="text-primary">Datos Factura</h5>
                                            <div class="row">
                                              <div class="col-md-6">
                                                  <div class="form-group">
                                                      <label class="control-label">Tiempo pago</label>
                                                      <select class="control-label" class="form-control" v-model="factura.plazoPagoId">
                                                          <option v-for="plazoPago in plazosPago" v-bind:value="plazoPago.id">{{plazoPago.descripcion}}</option>
                                                      </select>
                                                  </div>
                                              </div>

                                              <div class="col-md-6">
                                                  <div class="form-group">
                                                      <label class="control-label"></label>
                                                      <input type="text" class="form-control" value="N°0" disabled="" />
                                                  </div>
                                              </div>
                                            </div>

                                            <div class="row">
                                              <div class="col-md-4">
                                                  <div class="form-group">
                                                      <label class="control-label">Tipo documento</label>
                                                      <div class="radio">
                                                            <label>
                                                                <input type="radio" name="optionsRadios" checked>
                                                                Nota venta
                                                            </label>
                                                      </div>
                                                      <div class="radio">
                                                            <label>
                                                                <input type="radio" name="optionsRadios">
                                                                Factura
                                                            </label>
                                                      </div>
                                                  </div>
                                              </div>

                                              <div class="col-md-4">
                                                  <div class="form-group">
                                                      <label class="control-label">Fecha Inicio</label>
                                                      <input type="date" class="form-control" value="0"/>
                                                  </div>
                                              </div>


                                              <div class="col-md-4">
                                                  <div class="form-group">
                                                      <label class="control-label">Fecha Vencimiento</label>
                                                      <input type="text" class="form-control" value="dd/mm/yyyy" disabled />
                                                  </div>
                                              </div>
                                            </div>
                                        </fieldset>

                                        <!--formulario de cliente-->
                                        <fieldset>
                                            <h5 class="text-primary">Datos Cliente</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                      <div class="form-group">
                                                          <label class="control-label">Nombre</label>
                                                          <input type="text" class="form-control" disabled v-model="cliente.nombreCompleto"/>
                                                      </div>
                                                </div>
                                                <div class="col-md-6">
                                                      <input type="button" @click="buscarCliente" class="btn btn-default right" value="Buscar" />
                                                </div>
                                            </div>
                                            <div class="row">                                                
                                                <div class="col-md-12">
                                                      <div class="form-group">
                                                          <label class="control-label">Dirección</label>
                                                          <textarea  v-model="cliente.direccionFiscal" class="form-control" disabled></textarea>
                                                      </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                      <div class="form-group">
                                                          <label class="control-label">DNI o RUC</label>
                                                          <input type="text" class="form-control" disabled v-model="cliente.rucODni"/>
                                                      </div>
                                                </div>
                                                <div class="col-md-6">
                                                      <div class="form-group">
                                                          <label class="control-label">Telefono</label>
                                                          <input type="text" class="form-control" disabled v-model="cliente.telefono"/>
                                                      </div>
                                                </div>
                                            </div>

                                        </fieldset>

                                        <!--formulario de producto-->
                                        <fieldset>
                                            <h5 class="text-primary">Datos Producto</h5>
                                            <div class="row">
                                                <div class="col-md-4">
                                                      <div class="form-group">
                                                          <label class="control-label">Código</label>
                                                          <input type="text" class="form-control" v-model="producto.id" disabled />
                                                      </div>
                                                </div>
                                                <div class="col-md-5">
                                                      <div class="form-group">
                                                          <label class="control-label">Nombre</label>
                                                          <input type="text" class="form-control" disabled v-model="producto.descripcion"/>
                                                      </div>
                                                </div>
                                                <div class="col-md-3">
                                                      <input type="button" class="btn btn-default right" value="Buscar" @click="buscarProducto" />
                                                </div>
                                            </div>

                                            <div class="row">                               
                                                <div class="col-md-4">
                                                      <div class="form-group">
                                                          <label class="control-label">Stock</label>
                                                          <input type="text" class="form-control" disabled v-model="producto.stock"/>
                                                      </div>
                                                </div>
                                                <div class="col-md-4">
                                                      <!--dependerá del plazo de pago-->
                                                      <div class="form-group">
                                                          <label class="control-label">Precio unitario</label>
                                                          <input type="text" class="form-control" disabled v-model="producto.precioVenta"/>
                                                      </div>
                                                </div>
                                                <div class="col-md-2">
                                                      <div class="form-group">
                                                          <label class="control-label">Cantidad</label>
                                                          <input type="number" class="form-control"  v-model="producto.cantidad" placeholder="0" />
                                                      </div>
                                                </div>
                                            </div>

                                            <div class="row">                               
                                                <div class="col-md-12">
                                                      <input type="button" class="btn btn-default right" value="Agregar" 
                                                      @click="agregarProducto"/>
                                                </div>
                                            </div>


                                            <!-- Listado de productos - detalle de orden compras -->
                                            <table class="table lista">
                                                <thead class="text-primary">
                                                    <th>Código</th>
                                                    <th>Nombre</th>
                                                    <th>Cantidad</th>
                                                    <th>Prec. Venta</th>
                                                    <th>SubTotal</th> <!--calcular-->
                                                    <th>Acciones</th>
                                                </thead>
                                                <tbody>      
                                                    

                                                    <!--si no hay productos mostrar-->
                                                    <tr v-if="productos.length==0"><td colspan="6" textAlign="center">Lista Vacía</td></tr>

                                                    <!--en otro caso, mostrar todos los productos-->
                                                    <tr v-for="(producto,index) in productos">
                                                        <td>{{producto.id}}</td>
                                                        <td class="text-primary">{{producto.descripcion}}</td>
                                                        <td class="text-primary">{{producto.cantidad}}</td>
                                                        <td>S/.{{producto.precioVenta}}</td>
                                                        <td class="text-primary">{{producto.precioVenta*producto.cantidad | currency}}</td>
                                                        <td><a @click="quitarProducto(index)" href="#editar-producto">
                                                            <i class="material-icons">clear</i>
                                                        </a></td>                   
                                                     </tr>
                                                </tbody>
                                            </table>
                                        </fieldset>


                                        <div class="row flex-column">
                                                <div class="col-md-3 flex-item-right">
                                                
                                                        <div class="form-group">
                                                            <label class="control-label">SubTotal
                                                              <input type="text" class="form-control"  disabled="" v-model="factura.subTotal"/>
                                                            </label>
                                                        </div>
                                                
                                                
                                                        <div class="form-group">
                                                            <label class="control-label">IGV
                                                              <input type="text" class="form-control"  disabled="" v-model="factura.igv"/>
                                                            </label>
                                                        </div>
                                                
                                                
                                                        <div class="form-group">
                                                            <label class="control-label">Descuento
                                                              <input type="number" step="0.01" class="form-control" v-model="factura.descuento"/>
                                                            </label>
                                                        </div>
                                                
                                                
                                                        <div class="form-group">
                                                            <label class="control-label">Total
                                                              <input type="text" class="form-control"  disabled="" v-model="factura.total" />
                                                            </label>
                                                        </div>                                        
                                                </div>
                                          
                                                <div class="form-group flex-item-center">
                                                  <label>
                                                    <input type="button" class="btn btn-default" value="Pagar"  />
                                                  </label>
                                                </div>
                                                
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--footer-->
            <footer class="footer" th:replace="fragments/footer :: footer"></footer> 
        
        </div>
    </div>

    <!--dependencias JS-->
    <div th:replace="fragments/footer_dependencies :: dependencies"></div> 

    <!--modal de buscar producto-->
    <div th:replace="fragments/buscar_producto :: buscar-producto"></div> 
    <!--modal de buscar cliente-->
    <div th:replace="fragments/buscar_cliente :: buscar-cliente"></div> 

    <!--obtener servicio de ordenCompra-->
    <!--<script th:src="@{/app/ordenCompraService.js}"></script>-->

    <script type="text/javascript">                
        var vm;
        $(document).ready(function() {
                  //VUE FILTROS
                  Vue.filter('currency', function (value) {
                      return parseFloat(value).toFixed(2);
                  });
                  //VUE VISTA-MODELO
                    //modelo
                    var data={
                        factura:{
                          plazoPagoId:1,                          
                          subTotal:0.0,
                          descuento:0.0,
                          igv:0.0,
                          total:0.0
                        },
                        cliente:{
                            rucODni:'',
                            nombreCompleto:'',
                            direccionFiscal:'',
                            direccionEntrega:'',
                            telefono:'',
                            email:'',
                            estadoId:6,                            
                            estado:'0',
                        },
                        producto:{
                          id:0,
                          descripcion:'',
                          precioCompra:0.0,
                          precioVenta:0.0,
                          precioPack7:0.0,
                          precioPack15:0.0,
                          stock:0,
                          estadoId:0,
                          estado:'0',
                          cantidad:0,
                        },
                        productos:[],
                        plazosPago:[],                        
                        busqueda:{

                        }

                    };



                    var calcularTotal=function (val) {
                              this.factura.igv=1.18*this.factura.subTotal;
                              this.factura.total =  this.factura.igv - this.factura.descuento;
                    };

                    //vista-modelo
                    vm = new Vue({
                        el: "#factura",
                        data,
                        beforeCreate: function(){
                            //obteniendo los plazos de pago para el combo
                            $.ajax({
                                  url:'/plazos-pago',
                                  method:'get',
                                  success:(resp)=>{
                                    if(resp.error==0) this.plazosPago=resp.data;
                                  }
                                });                            

                        }, //métodos
                        watch:{
                            'factura.subTotal': calcularTotal,
                            'factura.descuento': calcularTotal
                        },
                        methods:{
                        
                            buscarCliente: function(){
                                buscarCliente.show(
                                    //cuando se seleccione el cliente de la otra pantalla
                                    (resp,cliente)=>{
                                            modal('Generar factura',resp.message);
                                            if(resp.error==0) {                                              
                                              for(var attr in this.cliente)
                                                  this.cliente[attr]=cliente[attr];
                                            }

                                    });
                            },
                            realizarSumatoria: function(){
                                let sumatoria=0;
                                  for(var i in this.productos)                                
                                    sumatoria=this.productos[i].cantidad*this.productos[i].precioVenta;
                                this.factura.subTotal=sumatoria;
                            },
                            buscarProducto: function(){
                                buscarProducto.show(
                                    //cuando se seleccione el cliente de la otra pantalla
                                    (resp,producto)=>{
                                            modal('Generar factura',resp.message);
                                            if(resp.error==0) {                                              
                                              for(var attr in this.producto)
                                                  this.producto[attr]=producto[attr];
                                              this.producto.cantidad=0;
                                            }

                                    });
                            },
                            //quitar producto de la lista
                            quitarProducto: function(index){
                              this.productos.splice(index,1);
                              this.realizarSumatoria();
                            },
                            //agregar producto a la lista
                            agregarProducto: function(){                              
                              this.productos.push($.extend(true, {}, this.producto));
                              this.realizarSumatoria();
                            },
                            //limpiar formulario de producto
                            cleanProducto: function(){
                              this.producto={
                                  id:0,
                                  descripcion:'',
                                  precioCompra:0.0,
                                  precioVenta:0.0,
                                  precioPack7:0.0,
                                  precioPack15:0.0,
                                  stock:0,
                                  estadoId:0,
                                  estado:'0',
                                  cantidad:0,
                                };    
                            }
                        }
                    });
        });
    </script>

</body>


</html>